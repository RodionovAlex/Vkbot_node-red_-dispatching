[
    {
        "id": "b719385365abbf8a",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ VK",
        "func": "// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ VK API\nconst token = '';\nconst peer_id = '';\nconst version = '';\n\n// –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ payload\nconst text = msg.payload;\n\n// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º random_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è)\nconst random_id = Date.now(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º—Å\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞\nmsg.url = `https://api.vk.com/method/messages.send?peer_id=${peer_id}&message=${encodeURIComponent(text)}&random_id=${random_id}&access_token=${token}&v=${version}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 900,
        "wires": [
            [
                "c56f3e5365dce008"
            ]
        ]
    },
    {
        "id": "c56f3e5365dce008",
        "type": "http request",
        "z": "00ba59b3853ff96b",
        "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ VK",
        "method": "GET",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1180,
        "y": 900,
        "wires": [
            [
                "8cbf1f576134338e"
            ]
        ]
    },
    {
        "id": "72a0bd6861043a2f",
        "type": "inject",
        "z": "00ba59b3853ff96b",
        "name": "–î–∞—Ç—á–∏–∫–∏  (true)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 130,
        "y": 820,
        "wires": [
            [
                "3d54907ccd814a6e",
                "7a75e8773cd14496",
                "8e043abfab67ed5e",
                "49d35a35c6cf74b2"
            ]
        ]
    },
    {
        "id": "7a2c07d00bc0350c",
        "type": "inject",
        "z": "00ba59b3853ff96b",
        "name": "–î–∞—Ç—á–∏–∫–∏ (false)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "false",
        "payloadType": "bool",
        "x": 120,
        "y": 860,
        "wires": [
            [
                "3d54907ccd814a6e",
                "7a75e8773cd14496"
            ]
        ]
    },
    {
        "id": "3d54907ccd814a6e",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "‚Ññ1",
        "func": "msg.topic = \"–ù1.1\"; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º ID –¥–∞—Ç—á–∏–∫–∞\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 820,
        "wires": [
            [
                "c60fd0f3fdaa8478"
            ]
        ]
    },
    {
        "id": "7a75e8773cd14496",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "‚Ññ2",
        "func": "msg.topic = \"–ù1.2\"; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º ID –¥–∞—Ç—á–∏–∫–∞\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 860,
        "wires": [
            [
                "c60fd0f3fdaa8478"
            ]
        ]
    },
    {
        "id": "51b9e0f8d4997c67",
        "type": "inject",
        "z": "00ba59b3853ff96b",
        "name": "6",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "6",
        "payloadType": "num",
        "x": 110,
        "y": 1040,
        "wires": [
            [
                "52bfb1b7a4e59be0",
                "ad26dc878fcf0f6d"
            ]
        ]
    },
    {
        "id": "47cee9ac0092edc4",
        "type": "inject",
        "z": "00ba59b3853ff96b",
        "name": "15",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "15",
        "payloadType": "num",
        "x": 110,
        "y": 1000,
        "wires": [
            [
                "52bfb1b7a4e59be0",
                "ad26dc878fcf0f6d"
            ]
        ]
    },
    {
        "id": "52bfb1b7a4e59be0",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "‚Ññ5 ",
        "func": "if (msg.payload < 7.5) {\n    msg.payload = true;\n} else {\n    msg.payload = false;\n}\nmsg.topic = \"–¢ 2.4\"; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º ID –¥–∞—Ç—á–∏–∫–∞\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 1000,
        "wires": [
            [
                "c60fd0f3fdaa8478"
            ]
        ]
    },
    {
        "id": "ad26dc878fcf0f6d",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "‚Ññ6",
        "func": "if (msg.payload < 10.5) {\n    msg.payload = true;\n} else {\n    msg.payload = false;\n}\nmsg.topic = \"–¢ 2.5\"; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º ID –¥–∞—Ç—á–∏–∫–∞\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 1040,
        "wires": [
            [
                "c60fd0f3fdaa8478"
            ]
        ]
    },
    {
        "id": "17200225544825d9",
        "type": "inject",
        "z": "00ba59b3853ff96b",
        "name": "–î–∞—Ç—á–∏–∫–∏  (true)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 130,
        "y": 900,
        "wires": [
            [
                "8e043abfab67ed5e",
                "49d35a35c6cf74b2"
            ]
        ]
    },
    {
        "id": "549648c5de9871fc",
        "type": "inject",
        "z": "00ba59b3853ff96b",
        "name": "–î–∞—Ç—á–∏–∫–∏ (false)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "topic": "",
        "payload": "false",
        "payloadType": "bool",
        "x": 120,
        "y": 940,
        "wires": [
            [
                "8e043abfab67ed5e",
                "49d35a35c6cf74b2"
            ]
        ]
    },
    {
        "id": "8e043abfab67ed5e",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "‚Ññ3",
        "func": "msg.topic = \"P2.1\"; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º ID –¥–∞—Ç—á–∏–∫–∞\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 900,
        "wires": [
            [
                "c60fd0f3fdaa8478"
            ]
        ]
    },
    {
        "id": "49d35a35c6cf74b2",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "‚Ññ4",
        "func": "msg.topic = \"P2.2\"; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º ID –¥–∞—Ç—á–∏–∫–∞\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 960,
        "wires": [
            [
                "c60fd0f3fdaa8478"
            ]
        ]
    },
    {
        "id": "c60fd0f3fdaa8478",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "–•—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ ",
        "func": "// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞\nif (!global.fileStorage) {\n    global.fileStorage = {\n        read: function (path) {\n            try {\n                return JSON.parse(global.get('file_' + path) || '{}');\n            } catch (e) {\n                node.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', e);\n                return {};\n            }\n        },\n        write: function (path, data) {\n            global.set('file_' + path, JSON.stringify(data));\n        }\n    };\n}\n\nconst storagePath = 'alarms_storage';\n\nconst storage = {\n    get: function (key) {\n        const data = global.fileStorage.read(storagePath);\n        return data[key] || {};\n    },\n    set: function (key, value) {\n        const data = global.fileStorage.read(storagePath);\n        data[key] = value;\n        global.fileStorage.write(storagePath, data);\n    }\n};\n\ntry {\n    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Ç–µ–∫—É—â–∏–µ –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n    if (Object.keys(storage.get('alarms')).length === 0) {\n        storage.set('alarms', {});\n        storage.set('previousStates', {});  // –î–æ–±–∞–≤–ª—è–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π\n        storage.set('pendingChanges', {});\n    }\n\n    const alarmId = msg.topic.toString();\n    const newStatus = msg.payload;\n    const alarms = storage.get('alarms');\n    const previousStates = storage.get('previousStates');  // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º\n    if (alarms[alarmId] !== undefined) {\n        previousStates[alarmId] = alarms[alarmId];\n    }\n\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è\n    if (alarms[alarmId] === newStatus) return null;\n\n    // –§–∏–∫—Å–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π\n    const pendingChanges = storage.get('pendingChanges');\n    pendingChanges[alarmId] = newStatus;\n    storage.set('pendingChanges', pendingChanges);\n    storage.set('previousStates', previousStates);  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n\n    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π\n    if (!context.get('timeout')) {\n        context.set('timeout', true);\n\n        setTimeout(() => {\n            context.set('timeout', false);\n\n            const currentAlarms = storage.get('alarms');\n            const allChanges = storage.get('pendingChanges');\n            const prevStates = storage.get('previousStates');  // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n\n            let message = \"–û–±—ä–µ–∫—Ç ‚Ññ1üè†\\n\\n\";\n            const resolved = [];\n            const newAlarms = [];\n\n            for (const [id, status] of Object.entries(allChanges)) {\n                const wasActive = prevStates[id] === true;  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n                if (wasActive && !status) resolved.push(`${id} –≤ –Ω–æ—Ä–º–µ ‚úîÔ∏è`);\n                if (!wasActive && status) newAlarms.push(`–ê–≤–∞—Ä–∏—è –≤ ${id}‚ùó`);\n                currentAlarms[id] = status;\n            }\n\n            if (resolved.length > 0) message += \"–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∞–≤–∞—Ä–∏–∏ ‚úÖ:\\n\" + resolved.join('\\n') + \"\\n\\n\";\n            if (newAlarms.length > 0) message += \"–ù–æ–≤—ã–µ –∞–≤–∞—Ä–∏–∏ üî¥:\\n\" + newAlarms.join('\\n') + \"\\n\\n\";\n            message += `–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤–∞—Ä–∏–πüö®: ${Object.values(currentAlarms).filter(s => s).length}`;\n\n            storage.set('alarms', currentAlarms);\n            storage.set('pendingChanges', {});\n\n            node.send({ payload: message });\n        }, 100);\n    }\n} catch (err) {\n    node.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', err);\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 900,
        "wires": [
            [
                "b719385365abbf8a"
            ]
        ]
    },
    {
        "id": "be8b8267a4d8789f",
        "type": "function",
        "z": "00ba59b3853ff96b",
        "name": "–°–±—Ä–æ—Å –∞–≤–∞—Ä–∏–π",
        "func": "// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ç–æ–º—É –∂–µ —Ö—Ä–∞–Ω–∏–ª–∏—â—É, —á—Ç–æ –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥\nconst storagePath = 'alarms_storage';\n\n// –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º (—Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ)\nif (!global.fileStorage) {\n    global.fileStorage = {\n        read: function(path) {\n            try {\n                return JSON.parse(global.get('file_' + path) || '{}');\n            } catch (e) {\n                node.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è:', e);\n                return {};\n            }\n        },\n        write: function(path, data) {\n            global.set('file_' + path, JSON.stringify(data));\n        }\n    };\n}\n\n// –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π\nconst storage = {\n    set: function(key, value) {\n        const data = global.fileStorage.read(storagePath);\n        data[key] = value;\n        global.fileStorage.write(storagePath, data);\n    }\n};\n\n// –û—á–∏—â–∞–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ\nstorage.set('alarms', {});\nstorage.set('previousStates', {});\nstorage.set('pendingChanges', {});\n\n// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ\nmsg.payload = \"‚úÖ –í—Å–µ –∞–≤–∞—Ä–∏–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å–±—Ä–æ—à–µ–Ω—ã!\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 960,
        "wires": [
            [
                "3a52e75ec6fa486e"
            ]
        ]
    },
    {
        "id": "14210d9e4d46468e",
        "type": "inject",
        "z": "00ba59b3853ff96b",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 680,
        "y": 960,
        "wires": [
            [
                "be8b8267a4d8789f"
            ]
        ]
    },
    {
        "id": "3a52e75ec6fa486e",
        "type": "debug",
        "z": "00ba59b3853ff96b",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1100,
        "y": 960,
        "wires": []
    },
    {
        "id": "8cbf1f576134338e",
        "type": "debug",
        "z": "00ba59b3853ff96b",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1340,
        "y": 900,
        "wires": []
    },
    {
        "id": "c60a3f1e40781f46",
        "type": "comment",
        "z": "00ba59b3853ff96b",
        "name": "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ",
        "info": "1. –í—Å–µ inject —Å–¥–µ–ª–∞–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —É–∑–µ–ª –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ!\n2. –î–∞—Ç—á–∏–∫–∏ ‚Ññ4 –∏ ‚Ññ5 –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–º–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö —á–∏—Å–ª–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫.\n3. –î–ª—è —Å–∞–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è peer id, token, –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å version.\n4. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –µ—â—ë –Ω–µ–±–æ–ª—å—à–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –æ–± –∞–≤–∞—Ä–∏—è—Ö.",
        "x": 130,
        "y": 780,
        "wires": []
    },
    {
        "id": "a044389091fb324b",
        "type": "comment",
        "z": "00ba59b3853ff96b",
        "name": "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ",
        "info": "1. –í —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–π –º—ã –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ Vk –±–æ—Ç–µ",
        "x": 970,
        "y": 860,
        "wires": []
    }
]